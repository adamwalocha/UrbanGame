# --- !Ups

create table "GAMES" ("id" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,"name" VARCHAR NOT NULL,"version" INTEGER DEFAULT 1 NOT NULL,"description" VARCHAR NOT NULL,"location" VARCHAR NOT NULL,"operatorId" INTEGER NOT NULL,"created" TIMESTAMP NOT NULL,"updated" TIMESTAMP NOT NULL,"startTime" TIMESTAMP NOT NULL,"endTime" TIMESTAMP NOT NULL,"started" TIMESTAMP,"ended" TIMESTAMP,"winning" VARCHAR DEFAULT 'max_points' NOT NULL,"nWins" INTEGER DEFAULT 1 NOT NULL,"difficulty" VARCHAR DEFAULT 'easy' NOT NULL,"maxPlayers" INTEGER DEFAULT 1000000 NOT NULL,"awards" VARCHAR NOT NULL,"status" VARCHAR DEFAULT 'project' NOT NULL,"image" VARCHAR DEFAULT 'games/gameicon.png' NOT NULL,"tasksNo" INTEGER DEFAULT 0 NOT NULL,"numberOfPlayers" INTEGER DEFAULT 0 NOT NULL);
create unique index "g_idx1" on "GAMES" ("name");
create table "NOTIFICATIONS" ("id" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL,"gameId" INTEGER NOT NULL,"version" INTEGER DEFAULT 1 NOT NULL,"name" VARCHAR NOT NULL,"deadline" TIMESTAMP NOT NULL);
create table "OPERATORS" ("id" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,"email" VARCHAR NOT NULL,"password" VARCHAR NOT NULL,"name" VARCHAR NOT NULL,"logo" VARCHAR DEFAULT 'users/logo.png' NOT NULL,"description" VARCHAR,"permission" VARCHAR NOT NULL,"created" TIMESTAMP NOT NULL,"modified" TIMESTAMP NOT NULL,"validated" BOOLEAN DEFAULT false NOT NULL,"token" VARCHAR);
create table "SKINS" ("id" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,"gameId" INTEGER NOT NULL,"icon" VARCHAR DEFAULT 'games/gameicon.png' NOT NULL);
create table "TASKS" ("id" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL,"gameId" INTEGER NOT NULL,"version" INTEGER DEFAULT 1 NOT NULL,"category" VARCHAR NOT NULL,"name" VARCHAR NOT NULL,"detailsJson" VARCHAR NOT NULL,"answerJson" VARCHAR NOT NULL,"maxpoints" INTEGER NOT NULL,"maxattempts" INTEGER NOT NULL,"timeLimit" TIMESTAMP,"lat" DOUBLE,"lon" DOUBLE,"rangeLimit" DOUBLE);
create table "USERGAMES" ("userId" INTEGER NOT NULL,"gameId" INTEGER NOT NULL,"joined" TIMESTAMP DEFAULT {ts '2013-07-01 21:30:43.894'} NOT NULL,"left" TIMESTAMP,"points" INTEGER DEFAULT 0 NOT NULL);
alter table "USERGAMES" add constraint "USERSGAMES_PK" primary key("userId","gameId");
create table "USERTASKS" ("userId" INTEGER NOT NULL,"gameId" INTEGER NOT NULL,"taskId" INTEGER NOT NULL,"status" VARCHAR DEFAULT 'not sent' NOT NULL,"points" INTEGER DEFAULT 0 NOT NULL,"attempts" INTEGER DEFAULT 0 NOT NULL,"time" TIMESTAMP);
alter table "USERTASKS" add constraint "USERTASKS_PK" primary key("userId","gameId","taskId");
create table "USERS" ("id" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,"login" VARCHAR NOT NULL,"hash" VARCHAR NOT NULL);
alter table "GAMES" add constraint "OP_FK" foreign key("operatorId") references "OPERATORS"("id") on update NO ACTION on delete NO ACTION;
alter table "NOTIFICATIONS" add constraint "GMN_FK" foreign key("gameId") references "GAMES"("id") on update NO ACTION on delete NO ACTION;
alter table "SKINS" add constraint "GM_FK" foreign key("gameId") references "GAMES"("id") on update NO ACTION on delete NO ACTION;
alter table "TASKS" add constraint "GMT_FK" foreign key("gameId") references "GAMES"("id") on update NO ACTION on delete NO ACTION;
alter table "USERGAMES" add constraint "USERGAMES_GAMES_FK" foreign key("gameId") references "GAMES"("id") on update NO ACTION on delete NO ACTION;
alter table "USERGAMES" add constraint "USERGAMES_USERS_FK" foreign key("userId") references "USERS"("id") on update NO ACTION on delete NO ACTION;
alter table "USERTASKS" add constraint "USERTASKS_GAMES_FK" foreign key("gameId") references "GAMES"("id") on update NO ACTION on delete NO ACTION;
alter table "USERTASKS" add constraint "USERTASKS_USERS_FK" foreign key("userId") references "USERS"("id") on update NO ACTION on delete NO ACTION;
alter table "USERTASKS" add constraint "USERTASKS_TASKS_FK" foreign key("gameId","taskId") references "TASKS"("gameId","id") on update NO ACTION on delete NO ACTION;


create alias geodistance as $$
 double geodistance(double lat1, double lon1, double lat2, double lon2) {
      double Radius = 6372.797560856;
      double dLat = Math.toRadians(lat2-lat1);  
      double dLon = Math.toRadians(lon2-lon1);  
      double a = Math.sin(dLat/2) * Math.sin(dLat/2) +  
         Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2)) *  
         Math.sin(dLon/2) * Math.sin(dLon/2);  
      double c = 2 * Math.asin(Math.sqrt(a));  
      return Radius * c;  
   }
$$;

# --- !Downs

